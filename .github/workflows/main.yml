name:  Start Ideas
# Trigger this workflow on pushes to the specified branch
on:
  pull_request:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest # Run this job on the latest Ubuntu version

    steps:
      - name: Start Friday
        env:
          PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }} # Reference the private key stored in GitHub Secrets
        run: |
          echo "$PRIVATE_KEY" > private_key.pem # Write the private key to a file
          chmod 600 private_key.pem # Set the appropriate permissions for the key file

          # Establish an SSH connection and execute commands on the remote server
          ssh -o StrictHostKeyChecking=no -i private_key.pem -tt bcumbie@35.208.101.221 <<EOF  
            # Here Document, allows for multiple commands while connectd to server 
            cd "/home/bcumbie/solid-guide-subdomain"

            # Update code first
            git pull --ff-only

            # Install deps (use ci only if lockfile exists)
            if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
              npm ci --omit=dev
            else
              npm install --omit=dev
            fi

            # Idempotent PM2 (restart if exists; else start)
            if pm2 describe "ideas-app" >/dev/null 2>&1; then
              PORT=3000 pm2 restart "ideas-app" --update-env
            else
              PORT=3000 pm2 start "app.mjs" --name "ideas-app" --env production
            fi

            pm2 save
            exit
          EOF

          rm -f private_key.pem
          EOF

          rm -f private_key.pem # Remove the private key file after use for security
